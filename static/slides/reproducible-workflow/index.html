<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Reproducible workflow</title>
    <meta charset="utf-8" />
    <meta name="author" content="MACSS 30500   University of Chicago" />
    <script src="index_files/header-attrs/header-attrs.js"></script>
    <link href="index_files/panelset/panelset.css" rel="stylesheet" />
    <script src="index_files/panelset/panelset.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Reproducible workflow
]
.author[
### MACSS 30500 <br /> University of Chicago
]

---






class: inverse, middle

# A holistic workflow

---

## Workspace

When you are running a session of R, the workspace contains all the objects you created in that session: 
* Libraries with `library()`
* User-created objects (variables, functions, etc.)

Our goal: not to preserve the workspace but the code that produces that workspace

---

## Pets VS cattle?

&lt;img src="../../../../../../../img/individual-cows-vs-cattle.png" width="80%" style="display: block; margin: auto;" /&gt;

&lt;!-- https://blog.octo.com/en/pet-vs-cattle-from-server-craftsman-to-software-craftsman/ --&gt;

--

**Think of your R processes as livestock, not pets.**

---

## Save code, not workspace

**Advantages of saving code, not workspace:**
* Enforces reproducibility
* Easy to regenerate on-demand

--

**How to make this happen?**
* Always save code in your script

* Always start R with a blank state: an empty and new workspace
  * "Do you want to save your workspace?" No, thanks
  * Tools &gt; Global Options &gt; General 
      * uncheck “Restore .Rdata into workspace at startup”
      * set to Never "Save workspace to .RData on exit"

* Restart R often: Session &gt; Restart R

---

## Inefficient approaches to clear workspae

```r
rm(list = ls())
```

* Good intent, but poor execution
* Only deletes user-created objects
* Enforces hidden dependencies on things you ran before `rm(list = ls())`

Instead: restart your R session to make sure you are clearing everything from your workspace!

---

class: middle, center

&lt;iframe width="800" height="500" src="https://www.youtube.com/embed/GiPe1OiKQuk?start=0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen&gt;&lt;/iframe&gt;

---

## Avoid unknown unknowns

We want to restart our R session to avoid the unknown unknowns: e.g., we loaded something in the workspace that we did not even remember, or we have run previous scripts for which results are held, etc.

Solution: write every script like its running in a fresh process

--

There are some instances where running everything in a new session of R might be challenging: 

* Storing computationally demanding output
* In Rmd: `cache = TRUE`
* In regular R script:`write_rds()` to save &amp; `read_rds()` to import back

---

class: inverse, middle

# Project-based workflows

---

## How to store work

* Split work into projects
* **We already do this**
* But why? what is the value of this approach?

---

## Working directory

Folder that R takes as **default directory** every time you try to access files, scripts, etc.

Start a new session of R and type `getwd()` to check your current working directpry.

In R workbench it should be `"/home/your_cnetid"` e.g., `"/home/nardin"`

---

## Working dir with `setwd()` vs project-based workflow

Using `setwd()`to manually set your working directory:

```r
library(tidyverse)

# get current working directory
getwd()

# modify it
setwd("/Users/Sabrina Nardin/Desktop/something_something/foofy/data")

# reference directly data to import
foofy &lt;- read_csv("raw_foofy_data.csv")

# plot
p &lt;- ggplot(foofy, aes(x, y)) + geom_point()

# save p in fig folder, use .. notation to go up one level 
ggsave("../figures/foofy_scatterplot.png")
```
--

Is this code reproducible?

---

## Project-based workflow

Our goal: avoid specifying the working directory, and have it detected automatically. 

How? Using a project-based workflow, which maximizes: 
* File system discipline: one project, one folder with all material you need for that project; be intentional on where your project folder is located
* File path discipline: do not use long file paths for working directory, because it breaks reproducibility

--

Advantages:
* Ensures portability
* Reliable behavior

---

## RStudio Projects

R studio has something called "RStudio Projects" `.Rproj` to help us implementing this workflow

* Every homework and in-class exercise folder we have been using has a `.Rproj` file. This file helps R to automatically detect the working directory
* Example

---

## Working dir with `setwd()` vs project-based workflow

Review the previous example using `.Rproj`
File &gt; New Project &gt; Existing Directory (select New Directory if the folder has not been created yet)

If I set the Existing Directory to `"/Users/Sabrina Nardin/Desktop/something_something"`, 
The code can be modified as follows:

```r
library(tidyverse)

# get current working directory 
getwd()

# reference directly the data to import
foofy &lt;- read_csv("foofy/data/raw_foofy_data.csv")

# plot
p &lt;- ggplot(foofy, aes(x, y)) + geom_point()

# save p in fig folder
ggsave("foofy/figures/foofy_scatterplot.png")
```

---

## Use safe filepaths

Using R projects to encapsulate our project is great, and prevents a number of problems. 

However, at times even that does not guarantee that we move away from using absolute file paths, and we instead use relative file paths.

---

## Use safe filepaths

So far we have learned to:
* Avoid `setwd()` at all costs :)
* Split work into R projects
* Declare each folder as a project

In addition:
* Use `here()` to locate a file location independently from where the current working directory is. So even if the working dir gets changed, we still are able to retrieve the file

---

class: small

## `here::here()`


```r
library(here)
here()
```

```
## [1] "C:/Users/Sabrina Nardin/Desktop/course-site"
```

--

* Build a file path


```r
here("static", "extras", "awesome.txt")
## [1] "C:/Users/Sabrina Nardin/Desktop/course-site/static/extras/awesome.txt"
cat(readLines(here("static", "extras", "awesome.txt")))
## OMG this is so awesome!
```
    
--

* What if we change the working directory?


```r
setwd(here("static"))
getwd()
## [1] "C:/Users/Sabrina Nardin/Desktop/course-site/static"
cat(readLines(here("static", "extras", "awesome.txt")))
## OMG this is so awesome!
```

---

## Filepaths and R Markdown

Everytime you knit an `.Rmd` file, it always assumes that its location is the working directory, regardless of whatever you are doing in R. This is important to remember, and sometimes leads to complications.

Let's see an example with the supreme courts data you worked with for homework 3 

---

## Filepaths and R Markdown

Imagine the `"court-project"` folder is structured as follows:

```
data/
  scotus.csv
analysis/
  exploratory-analysis.Rmd
final-report.Rmd
scotus.Rproj
```

--

`.Rmd` and assumption of working directory:

In both of the `.Rmd` files `exploratory-analysis.Rmd` and `final-report.Rmd`, we have this piece of code: `read_csv("data/scotus.csv")`

* When placed in `final-report.Rmd`, will this code work?
* When placed in `exploratory-analysis.Rmd`, will this code work?

Run `read_csv(here("data", "scotus.csv"))` Will this code work?

---

class: inverse, middle

# Practice using reproducbile workflow within R

---

class: inverse, middle

# Personal R admin

---

## R startup procedures

* Customized startup
* `.Renviron`
* `.Rprofile`

---

## `.Renviron`

* Define sensitive information
* Set R specific environmental variables
* Does not use R code syntax
* `usethis::edit_r_environ()`

--

## Example `.Renviron`

```shell
R_HISTSIZE=100000
GITHUB_PAT=abc123
R_LIBS_USER=~/R/%p/%v
```

---

## `.Rprofile`

* R code to run when R starts up
* Runs after `.Renviron`
* Multiple `.Rprofile` files
    * Home directory (`~/.Rprofile`)
    * Each R Project folder
* `usethis::edit_r_profile()`

---

## Common items in `.Rprofile`

1. Set a default CRAN mirror
1. Write a welcome message
1. Customize their R prompt
1. Change options, screen width, numeric display
1. Store API keys/tokens that are necessary for only a single project

---

## Git tracking of `.Rprofile`

---

## Acknowledgments 

The content of these slides is derived in part from Benjamin Soltoff’s “Computing for the Social Sciences” course materials, licensed under the CC BY NC 4.0 Creative Commons License. Any errors or oversights are mine alone.
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "magula",
"highlightLines": true,
"highlightLanguage": "r",
"ratio": "16:9",
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
