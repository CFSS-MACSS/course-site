---
title: "Geospatial visualization: vector maps"
author: "INFO 5940 <br /> Cornell University"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature:
      highlightStyle: magula
      highlightLines: true
      highlightLanguage: r
      ratio: 16:9
      countIncrementalSlides: false
---

```{r setup, include = FALSE}
# generate CSS file
library(xaringanthemer)
style_duo_accent(
  primary_color = "#B31B1B",
  secondary_color = "#F8981D",
  inverse_header_color = "#222222",
  black_color = "#222222",
  header_font_google = xaringanthemer::google_font("Atkinson Hyperlegible"),
  text_font_google = xaringanthemer::google_font("Atkinson Hyperlegible"),
  code_font_google = xaringanthemer::google_font("Source Code Pro"),
  base_font_size = "24px",
  code_font_size = "20px",
  # title_slide_background_image = "https://github.com/uc-dataviz/course-notes/raw/main/images/hexsticker.svg",
  # title_slide_background_size = "contain",
  # title_slide_background_position = "top",
  header_h1_font_size = "2rem",
  header_h2_font_size = "1.75rem",
  header_h3_font_size = "1.5rem",
  extra_css = list(
    "h1" = list(
      "margin-block-start" = "0.4rem",
      "margin-block-end" = "0.4rem"
    ),
    "h2" = list(
      "margin-block-start" = "0.4rem",
      "margin-block-end" = "0.4rem"
    ),
    "h3" = list(
      "margin-block-start" = "0.4rem",
      "margin-block-end" = "0.4rem"
    ),
    ".tiny" = list("font-size" = "70%"),
    ".small" = list("font-size" = "90%"),
    ".midi" = list("font-size" = "150%"),
    ".tiny .remark-code" = list("font-size" = "70%"),
    ".small .remark-code" = list("font-size" = "90%"),
    ".midi .remark-code" = list("font-size" = "150%"),
    ".large" = list("font-size" = "200%"),
    ".xlarge" = list("font-size" = "600%"),
    ".huge" = list(
      "font-size" = "400%",
      "font-family" = "'Montserrat', sans-serif",
      "font-weight" = "bold"
    ),
    ".hand" = list(
      "font-family" = "'Gochi Hand', cursive",
      "font-size" = "125%"
    ),
    ".task" = list(
      "padding-right" = "10px",
      "padding-left" = "10px",
      "padding-top" = "3px",
      "padding-bottom" = "3px",
      "margin-bottom" = "6px",
      "margin-top" = "6px",
      "border-left" = "solid 5px #F1DE67",
      "background-color" = "#F3D03E"
    ),
    ".pull-left" = list(
      "width" = "49%",
      "float" = "left"
    ),
    ".pull-right" = list(
      "width" = "49%",
      "float" = "right"
    ),
    ".pull-left-wide" = list(
      "width" = "70%",
      "float" = "left"
    ),
    ".pull-right-narrow" = list(
      "width" = "27%",
      "float" = "right"
    ),
    ".pull-left-narrow" = list(
      "width" = "27%",
      "float" = "left"
    ),
    ".pull-right-wide" = list(
      "width" = "70%",
      "float" = "right"
    ),
    ".blue" = list(color = "#2A9BB7"),
    ".purple" = list(color = "#a493ba"),
    ".yellow" = list(color = "#f1de67"),
    ".gray" = list(color = "#222222")
  )
)

source(here::here("R", "slide-opts.R"))
knitr::opts_chunk$set(echo = FALSE)

# enable panelsets and default theme
xaringanExtra::use_panelset()
```

```{r pkgs, include = FALSE, cache = FALSE}
library(tidyverse)
library(sf)
library(ggmap)
library(tidycensus)
library(RColorBrewer)
library(patchwork)
library(here)
library(countdown)
library(flipbookr)

# easier to generate tidycensus maps
if (!identical(getOption("bitmapType"), "cairo") && isTRUE(capabilities()[["cairo"]])){
  options(bitmapType = "cairo")
}

set.seed(123)
theme_set(theme_minimal(base_size = 16))
```

# Map data file formats

* Vector files
    * Raster images
    * Numeric data
* Popular formats
    * Shapefile
    * GeoJSON
    
---

# Shapefile

* Encodes points, lines, and polygons
* Collection of files
    * `.shp` - geographic coordinates
    * `.dbf` - data associated with the geographic features
    * `.prj` - projection of the coordinates in the shapefile

---

# GeoJSON

* Uses **J**ava**S**cript **O**bject **N**otation (JSON) file format
    
    ```json
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [125.6, 10.1]
      },
      "properties": {
        "name": "Dinagat Islands"
      }
    }
    ```
* Plain text files

---

```{r echo = FALSE, fig.alt = "Three cute fuzzy monsters adding spatial geometries to an existing table of attributes using glue and tape, while one cuts out the spatial polygons. Title text reads 'sf: spatial data...simplified.' and a caption at the bottom reads 'sticky geometries: for people who love their maps and sanity.'"}
include_graphics(path = "/img/sf.png")
```

.footnote[Source: [Allison Horst](https://github.com/allisonhorst/stats-illustrations)]

---

# Simple features

* [Packages in R for spatial data](https://cran.r-project.org/web/views/Spatial.html)
* Tidy packages for spatial data
* Simple features and `sf`
    * Emphasizes spatial geometry
    * Describes how to store and retrieve objects
    * Defines geometrical operations

---

# What is a feature?

* Thing or an object in the real world
* Sets of features
* Geometry
* Attributes

---

# Dimensions

* Geometries composed of points
    * Coordinates in a 2-, 3- or 4-dimensional space
    * All points in a geometry have the same dimensionality
* X and Y coordinates
* Z coordinate
* M coordinate (measure associated with point rather than the feature)

---

# Simple feature geometry types

| type | description                                             |
| ---- | ------------------------------------------------------- |
| `POINT` | zero-dimensional geometry containing a single point |
| `LINESTRING` | sequence of points connected by straight, non-self intersecting line pieces; one-dimensional geometry |
| `POLYGON` | geometry with a positive area (two-dimensional); sequence of points form a closed, non-self intersecting ring; the first ring denotes the exterior ring, zero or more subsequent rings denote holes in this exterior ring |

--

* `MULTIPOINT`
* `MULTILINESTRING`
* `MULTIPOLYGON`

---

# Simple features in R

* Uses basic R data structures
* Data frame with one row per feature
* Lots of list columns

---

# Importing shapefiles

```{r import-usa-shape, echo = TRUE}
usa_shape <- st_read(dsn = here("static", "data", "cb_2020_us_state_5m", "cb_2020_us_state_5m.shp"))
```

---

# Importing shapefiles

```{r import-usa-shape-print, echo = TRUE}
usa_shape
```

---

# Importing GeoJSON files

```{r import-chi-json, echo = TRUE}
chi_json <- st_read(dsn = here("static", "data", "community-area-boundaries.geojson"))
```

---

# Importing GeoJSON files

```{r import-chi-json-print, echo = TRUE}
chi_json
```

---

# Drawing maps with `sf` objects

```{r import-usa, echo = TRUE}
usa <- st_read(dsn = here("static", "data", "cb_2020_us_state_5m", "cb_2020_us_state_5m.shp"))
```

---

# USA boundaries

.panelset.sideways[
```{r geom-sf, echo = TRUE, panelset = TRUE}
ggplot(data = usa) +
  geom_sf() #<<
```
]

---

# Plot a subset of a map

.panelset.sideways[
```{r usa-subset, echo = TRUE, panelset = TRUE}
usa_48 <- usa %>%
  filter(NAME %in% state.name) %>% #<<
  filter(NAME != "Alaska", NAME != "Hawaii") #<<

ggplot(data = usa_48) +
  geom_sf()
```
]

---

# Just another `ggplot()`

.panelset.sideways[
```{r usa-fill, echo = TRUE, panelset = TRUE}
ggplot(data = usa_48) +
  geom_sf(
    fill = "palegreen", #<<
    color = "black" #<<
  )
```
]

---

```{r, out.width = "60%"}
include_graphics(path = "https://imgs.xkcd.com/comics/contiguous_41_states.png")
```

.footnote[Source: [xkcd](https://xkcd.com/2394/)]

---

# `urbnmapr`

.panelset.sideways[
```{r urbnmapr, echo = TRUE, panelset = TRUE}
# remotes::install_github("UrbanInstitute/urbnmapr")
library(urbnmapr)

states_sf <- get_urbn_map("states", sf = TRUE) #<<

ggplot(data = states_sf) +
  geom_sf()
```
]

---

# Points

```{r import-crimes, include = FALSE}
crimes <- here("static", "data", "chicago-crimes.csv") %>%
  read_csv()
```

```{r import-crimes-fake, eval = FALSE}
crimes <- here("static", "data", "chicago-crimes.csv") %>%
  read_csv()
```

```{r chi-crimes, echo = TRUE}
crimes_homicide <- filter(.data = crimes, `Primary Type` == "HOMICIDE")
crimes_homicide
```

---

# Points

.panelset.sideways[
```{r scatter, echo = TRUE, out.width = "100%"}
ggplot(data = crimes_homicide,
       mapping = aes(x = Longitude,
                     y = Latitude)) +
  geom_point() #<<
```
]

---

# Points

.panelset.sideways[
```{r chi-crime, echo = TRUE, out.width = "100%"}
ggplot(data = chi_json) +
  geom_sf() + #<<
  geom_point( #<<
    data = crimes_homicide,
    mapping = aes(
      x = Longitude,
      y = Latitude
    ),
    shape = 1
  )
```

]

---

# Convert tibble to `sf` data frame

```{r crimes-sf, echo = TRUE}
crimes_homicide_sf <- st_as_sf(x = crimes_homicide, coords = c("Longitude", "Latitude"))
st_crs(crimes_homicide_sf) <- 4326 # set the coordinate reference system
crimes_homicide_sf
```

---

# Plotting with two sf data frames

.panelset.sideways[
```{r crimes-sf-plot, echo = TRUE, out.width = "100%"}
ggplot() +
  geom_sf(data = chi_json) +
  geom_sf(data = crimes_homicide_sf, shape = 1)
```
]

---

# Fill (choropleths)

```{r import-foreign, echo = TRUE}
fb_state <- read_csv(file = here("static", "data", "foreign-born.csv"))
fb_state
```

---

# Join the data

```{r usa-foreign-join, echo = TRUE}
usa_fb <- left_join(x = usa_48, y = fb_state, by = c("STATEFP" = "GEOID", "NAME"))
usa_fb
```

---

# Draw the map

.panelset.sideways[
```{r geom-map-state, echo = TRUE, out.width = "100%"}
ggplot(data = usa_fb) +
  geom_sf(mapping = aes(fill = pct_foreign))
```
]

---

# Spatial aggregation

```{r crimes-agg, echo = TRUE}
st_join(x = chi_json, y = crimes_homicide_sf)
```

---

```{r crimes-agg-map, include = FALSE, fig.width = 6}
chi_json %>%
  st_join(y = crimes_homicide_sf) %>%
  group_by(community) %>%
  count() %>%
  ggplot() +
  geom_sf(mapping = aes(fill = n))
```

`r chunk_reveal(chunk_name = "crimes-agg-map", break_type = "auto")`


---

# Exercise using household income

- American Community Survey
- [`tidycensus`](https://walker-data.com/tidycensus/)

```{r cache = FALSE}
countdown(minutes = 10)
```

---

# Bin data to discrete intervals

* Continuous vs. discrete variables for color
* Collapse to a discrete variable

---

# `cut_interval()`

```{r cut-interval, echo = TRUE}
usa_fb %>%
  mutate(rate_cut = cut_interval(pct_foreign, n = 6)) %>%
  ggplot() +
  geom_sf(aes(fill = rate_cut))
```

---

# `cut_number()`

```{r cut-number, echo = TRUE}
usa_fb %>%
  mutate(rate_cut = cut_number(pct_foreign, n = 6)) %>%
  ggplot() +
  geom_sf(aes(fill = rate_cut))
```

---

# Map projection

<iframe width="560" height="315" src="https://www.youtube.com/embed/vVX-PrBRtTY?rel=0" frameborder="0" allowfullscreen></iframe>

---

# Map projection

.center[

![[Mercator Projection](https://xkcd.com/2082/)](https://imgs.xkcd.com/comics/mercator_projection.png)

]

---

# Map projection

* Coordinate reference system
* `proj4string`

> <https://spatialreference.org/ref/epsg/>

---

# Mercator projection

```{r projections}
map_proj_base <- ggplot(data = usa_48) +
  geom_sf()
```

```{r mercator-sf, echo = TRUE, fig.height = 6}
map_proj_base +
  coord_sf(crs = 3785) +
  ggtitle("Mercator projection")
```

---

# Projection using standard lines

```{r projection-rest}
{
  map_proj_base +
    coord_sf(crs = 4326) +
    labs(
      title = "WGS 84",
      subtitle = 'coord_sf(crs = 4326)'
    )
} +
  {
    map_proj_base +
      coord_sf(crs = 2163) +
      labs(
        title = "US National Atlas Equal Area",
        subtitle = 'coord_sf(crs = 2163)'
      )
  } +
  {
    map_proj_base +
      coord_sf(crs = 3085) +
      labs(
        title = "Texas Centric Albers Equal Area",
        subtitle = 'coord_sf(crs = 3085)'
      )
  } +
  {
    map_proj_base +
      coord_sf(crs = 3174) +
      labs(
        title = "Great Lakes Albers",
        subtitle = 'coord_sf(crs = 3174)'
      )
  } +
  plot_layout(ncol = 2, nrow = 2) &
  theme_minimal(base_size = rcfss::base_size * .75)
```

---

# Adjusting color intervals and projections

```{r cache = FALSE}
countdown(minutes = 8)
```

