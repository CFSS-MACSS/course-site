---
title: "A deep dive into R Markdown"
author: "MACSS 30500 <br /> University of Chicago"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature:
      highlightStyle: magula
      highlightLines: true
      highlightLanguage: r
      ratio: 16:9
      countIncrementalSlides: false
---

```{r setup, include = FALSE}
# generate CSS file
library(xaringanthemer)
style_duo_accent(
  primary_color = "#011f4b",
  secondary_color = "#bbd6c7",
  inverse_header_color = "#222222",
  black_color = "#222222",
  header_font_google = xaringanthemer::google_font("Atkinson Hyperlegible"),
  text_font_google = xaringanthemer::google_font("Atkinson Hyperlegible"),
  code_font_google = xaringanthemer::google_font("Source Code Pro"),
  base_font_size = "24px",
  code_font_size = "20px",
  # title_slide_background_image = "https://github.com/uc-dataviz/course-notes/raw/main/images/hexsticker.svg",
  # title_slide_background_size = "contain",
  # title_slide_background_position = "top",
  header_h1_font_size = "2rem",
  header_h2_font_size = "1.75rem",
  header_h3_font_size = "1.5rem",
  extra_css = list(
    "h1" = list(
      "margin-block-start" = "0.4rem",
      "margin-block-end" = "0.4rem"
    ),
    "h2" = list(
      "margin-block-start" = "0.4rem",
      "margin-block-end" = "0.4rem"
    ),
    "h3" = list(
      "margin-block-start" = "0.4rem",
      "margin-block-end" = "0.4rem"
    ),
    ".tiny" = list("font-size" = "70%"),
    ".small" = list("font-size" = "90%"),
    ".midi" = list("font-size" = "150%"),
    ".tiny .remark-code" = list("font-size" = "70%"),
    ".small .remark-code" = list("font-size" = "90%"),
    ".midi .remark-code" = list("font-size" = "150%"),
    ".large" = list("font-size" = "200%"),
    ".xlarge" = list("font-size" = "600%"),
    ".huge" = list(
      "font-size" = "400%",
      "font-family" = "'Montserrat', sans-serif",
      "font-weight" = "bold"
    ),
    ".hand" = list(
      "font-family" = "'Gochi Hand', cursive",
      "font-size" = "125%"
    ),
    ".task" = list(
      "padding-right" = "10px",
      "padding-left" = "10px",
      "padding-top" = "3px",
      "padding-bottom" = "3px",
      "margin-bottom" = "6px",
      "margin-top" = "6px",
      "border-left" = "solid 5px #F1DE67",
      "background-color" = "#F3D03E"
    ),
    ".pull-left" = list(
      "width" = "49%",
      "float" = "left"
    ),
    ".pull-right" = list(
      "width" = "49%",
      "float" = "right"
    ),
    ".pull-left-wide" = list(
      "width" = "70%",
      "float" = "left"
    ),
    ".pull-right-narrow" = list(
      "width" = "27%",
      "float" = "right"
    ),
    ".pull-left-narrow" = list(
      "width" = "27%",
      "float" = "left"
    ),
    ".pull-right-wide" = list(
      "width" = "70%",
      "float" = "right"
    ),
    ".blue" = list(color = "#2A9BB7"),
    ".purple" = list(color = "#a493ba"),
    ".yellow" = list(color = "#f1de67"),
    ".gray" = list(color = "#222222")
  )
)

source(here::here("R", "slide-opts.R"))
xaringanExtra::use_panelset()
knitr::opts_chunk$set(
  echo = FALSE
)
```

```{r pkgs, include = FALSE, cache = FALSE}
library(tidyverse)
library(rcis)
library(here)
library(ymlthis)
library(countdown)

set.seed(1234)
theme_set(theme_minimal(base_size = rcis::base_size))
```

class: inverse, middle

# R Markdown

---

```{r}
include_graphics(path = "base.png")
```

---

## R Markdown: resources 

Assigned readings:

* `Rmarkdown.Rmd` from Lecture 2  `usethis::use_course("css-materials/intro-r")`
* Chapters 27 "R Markdown", 28 "Graphics for communication", and 29 "R Markdown formats" in [R for Data Science](http://r4ds.had.co.nz)

Additional resources:

* [R Markdown the definitive Guide](https://bookdown.org/yihui/rmarkdown/)
* [R Markdown cheat sheet](https://posit.co/resources/cheatsheets/?_page=2/)
* [Markdown and R Markdown](https://pjbartlein.github.io/REarthSysSci/markdown.html) by Pat Bartlein
* [R Markdown from R Studio](https://rmarkdown.rstudio.com/lesson-1.html) official documentation

---

## R Markdown and Markdown

**R Markdown**: text file that uses the extension `.Rmd`.

**Markdown**: text file that use the extension `.md`

* Similarities: 
  * they use the same syntax, R Markdown is just an extension of the markdown syntax
* Differences: 
  * R code cannot be executed in a `.md` VS we can embed and execute R code chunks in a `.Rmd `
  * An `.md` can be generated from a `.Rmd` but not the other way around

---

## R Markdown: Knitting process

R Markdown files allow to generate well-formatted documents (md, pdf, word, html, etc.) that include text, code, and output.

To create such documents, you “Knit” or “render” them in three ways: 

1. by clicking the “Knit” button in the script editor panel of your R Markdown file and select the desired output

1. by adding the desired output in the YAML header (e.g., `github_document`, `pdf_document`, `word_document`, `html_document`-- without $\LaTeX$ installed, rendering as pdf won't work)

1. by executing the command `rmarkdown::render("my-document.Rmd")` as explained [here](https://pkgs.rstudio.com/rmarkdown/reference/render.html). For example `rmarkdown::render("my-document.Rmd", output_format: html_document`)


---

## R Markdown: Knitting process with `render()`

```r
rmarkdown::render("my-document.Rmd", output_format = "html_document")
rmarkdown::render("my-document.Rmd", output_format = "all")
```

---

## R Markdown: Knitting process for presentations

* [ioslides](http://rmarkdown.rstudio.com/ioslides_presentation_format.html)
* [reveal.js](http://rmarkdown.rstudio.com/revealjs_presentation_format.html)
* [Slidy](http://rmarkdown.rstudio.com/slidy_presentation_format.html)
* [Beamer](http://rmarkdown.rstudio.com/beamer_presentation_format.html)
* [`xaringan`](https://bookdown.org/yihui/rmarkdown/xaringan.html)

---

## R Markdown: Knitting process

```{r}
include_graphics(path = "rmarkdownflow.png")
```

When you knit the document, R Markdown sends the .Rmd file to knitr, http://yihui.name/knitr/, which executes all of the code chunks and creates a new markdown (.md) document which includes the code and its output. The markdown file generated by knitr is then processed by pandoc, http://pandoc.org/, which is responsible for creating the finished file. The advantage of this two step workflow is that you can create a very wide range of output formats, as you’ll learn about in R markdown formats.

how it works 
```{r echo = FALSE, fig.alt = "A schematic representing rendering of Quarto documents from .qmd, to knitr or jupyter, to plain text markdown, then converted by pandoc into any number of output types including html, PDF, or Word document."}
#include_graphics(path = "/img/qmd_render_schema.png")
```

---

## R Markdown: Three main components

1. A **YAML header** surrounded by `---` at the top of the file

1. Text mixed with simple text formatting using the [Markdown syntax](../hw01-edit-README.html)

1. **Chunks** of R code surrounded by ` ``` `
To insert them:
  * keyboard shortcut Cmd/Ctrl + Alt + I
  * “Insert” button icon in the editor toolbar
  * manually type the chunk delimiters ` ```{r} and ``` `

---

## R Markdown: Basic Syntax

```` 
_Italics_ and *Italics*
````
*Italics* and _Italics_

--

````
__Bold__ and **Bold**
````
**Bold** and __Bold__

--

````
~~Strikethrough~~ 
````
~~Strikethrough~~ 

---

## R Markdown: Unordered lists

Use either `*`, `-`, or `+`, then a space, then the text:

.pull-left[

````
+ item 1
  + sub
  + sub
- item 2
  - sub
  - sub
+ item 3
  - sub
  * sub
- item 4
  * sub
  * sub
````

]
.pull-right[

+ item 1
  + sub
  + sub
- item 2
  - sub
  - sub
+ item 3
  - sub
  * sub
- item 4
  * sub
  * sub
]

---

## R Markdown: Ordered lists

Write the number 1, followed by a period, then a space, then the text. For nested lists, indent once and use `+`, `*`, or `-` followed by a space: 

.pull-left[

````
1. item 1
    + sub
        + sub sub
    + sub
1. item 2
    * sub
        * sub
1. item 3
    - sub
       + sub
````

]
.pull-right[

1. item 1
    + sub
        + sub sub
    + sub
1. item 2
    * sub
        * sub sub
    * sub
1. item 3
    - sub
        + sub sub
    
]

---

## R Markdown: Headers

Use `#` to add headers. The more `#` the smallest the header:

.pull-left[

````
# Main title, 1st level

## Section title, 2nd level

### Subsection title, 3rd level

Write regular-sized sentences without `#`

````

]
.pull-right[

# Main title, 1st level

## Section title, 2nd level

### Subsection title, 3rd level

Write regular-sized sentences without `#`

]

--

NB: in R scripts or in `.Rmd` code chunks, `#` are used for comments; and the number of `#` does not matter

---

## R Markdown: links, tables, pictures

**Link**: write the linked text in brackets `[]`, followed immediately by the URL in parentheses `()`. 

````
[R Studio](https://www.rstudio.com/)
````

**Picture**: make sure the picture is in your folder, then type `![text](picture link, "title")`. The title is optional.

**Table**: use `-----` for rows and `|` for columns. See https://www.markdownguide.org/extended-syntax/


---

## R Markdown: tables


```{r}
#youth <- gun_deaths %>% filter(age <= 65)
#knitr::kable(gun_deaths)
```

---

## R Markdown: tables

```{r}
#youth <- gun_deaths %>% filter(age <= 65)
#knitr::kable(gun_deaths, col.names = c("", "", ""), align = "ccc", caption = "Table 1.)
```



---

## R Markdown: Inline code

.small[
````{verbatim, echo = TRUE}
---
title: "Gun deaths"
output: html_document
---

```{r setup, include = FALSE}
library(tidyverse)
library(rcis)
```

## Gun deaths by age

Data for this plot come from the `gun_deaths` dataset. We have data about `r nrow(gun_deaths)` individuals killed by guns.
Only `r nrow(gun_deaths) - nrow(youth)` are older than 65. The distribution of the remainder is shown below:

```{r youth-dist, echo = FALSE}
youth <- gun_deaths %>%
  filter(age <= 65)
youth %>% 
  ggplot(aes(age)) + 
  geom_freqpoly(binwidth = 1)
```
````

]

---

## R Markdown: Inline code

```{r youth, include = FALSE}
youth <- gun_deaths %>%
  filter(age <= 65)
```

````{verbatim, lang = "markdown", echo = TRUE}
Data for this plot come from the `gun_deaths` dataset. 
We have data about `r nrow(gun_deaths)` individuals killed by guns.
Only `r nrow(gun_deaths) - nrow(youth)` are older than 65. 
The distribution of the remainder is shown below:
````

--

We have data about `r nrow(gun_deaths)` individuals killed by guns. Only `r nrow(gun_deaths) - nrow(youth)` are older than 65.

---

## R Markdown: Naming code chuncks 

A code chunck:
````{verbatim, lang = 'markdown', echo = TRUE}
```{r youth-dist, echo = FALSE, message = FALSE, warning = FALSE}
# code goes here
```
````

Advantages:

1. Navigate to specific chunks using the drop-down code navigator in the bottom-left of the script 
editor

1. Graphics produced by the chunks will have useful names

1 You can set up networks of cached chunks to avoid re-performing expensive computations on every run. More on that below.

---

## R Markdown: Code chuncks options


* `eval = FALSE`
* `include = FALSE`
* `echo = FALSE`
* `message = FALSE` or `warning = FALSE`
* `error = TRUE`
* `cache = TRUE`

---

## R Markdown: Code chuncks options

```{r}
include_graphics(path = "chunk_options.jpg")
```

Source: https://r4ds.had.co.nz/r-markdown.html#chunk-options
Full list:  full list at http://yihui.name/knitr/options/.

---

## Global options

```r
knitr::opts_chunk$set(
  echo = FALSE
)
```


---

class: inverse, middle

# Practice 1 ~8 min

Use `gun-deaths.Rmd`: 
create title for main section and subsections 
add in-line code for the graph (same example as before or add text describing the frequency polygon )
change settings in both graphs and knit (leave the default as html) to see results 

# Practice 2 ~ 8min

## Ice is back with my brand new invention

* Set `echo = FALSE` as a global option
* Enable caching as a global option and render the document. Look at the file structure for the cache. Now render the document again. Does it run faster?

```{r cache = FALSE, echo = FALSE}
countdown(minutes = 7)
```

## Stop, collaborate, and listen

* Render `gun-deaths.Rmd` as an HTML document
* Add text describing the frequency polygon

```{r cache = FALSE, echo = FALSE}
countdown(minutes = 5)
```


---

## YAML header specifications

````{verbatim, echo = TRUE}
---
title: "Gun deaths"
author: "Sabrina Nardin"
output: html_document
---
````

* **Y**et **A**nother **M**arkup **L**anguage
* Standardized format for storing hierarchical data in a human-readable syntax
* Defines how `rmarkdown` renders your `.Rmd` file


---

## YAML header specifications

````{verbatim, echo = TRUE}
---
title: "Gun deaths"
author: "Sabrina Nardin"
output: html_document
---
````

---

## YAML header specifications: Table of contents

````{verbatim, echo = TRUE}
---
title: "Gun deaths"
author: "Sabrina Nardin"
output: 
  html_document
    toc: true
    toc_depth: 2
---
````

---

## YAML header specifications: Apparence and Style


````{verbatim, echo = TRUE}
---
title: "Gun deaths"
author: "Sabrina Nardin"
output: 
  html_document
    theme: readable
    highlight: pygments
---
````


---

## YAML header specifications: Date as string

````{verbatim, echo = TRUE}
---
title: "Gun deaths"
author: "Sabrina Nardin"
date: "November 7, 2022"
output: html_document
---
````



---

## YAML header specifications: Date automatically added

Adding the date manually is not scalable. Instead, we want to add it automatically. Using the `lubridate` package:

````{verbatim, echo = TRUE}
---
title: "Gun deaths"
date: "`r lubridate::today()`"
output: html_document
---
````

---

## YAML header specifications: Date automatically added

Adding the date manually is not scalable. Instead, we want to add it automatically. Using `Sys.Date`:

````{verbatim, echo = TRUE}
---
title: "Gun deaths"
date: "`r Sys.Date()`"
output: html_document
---
````

`Sys.Date` returns the current day in the current time zone. The default uses the format year/month/day.

---

## YAML header specifications: Date automatically added

Adding the date manually is not scalable. Instead, we want to add it automatically. Using `Sys.Time`:

````{verbatim, echo = TRUE}
---
title: "Gun deaths"
date: "`r format (Sys.Time(), '%d, %B, %Y')`"
output: html_document
---
````

`Sys.time` returns an absolute date-time value which can be converted to various time zones, and it is customizable.

This format says we want the date as: numeric day, full name of the month, and numeric year, but it can be changed

---

## YAML header specifications: Date formats

```{r}
include_graphics(path = "r-dates.png")
```

Source: https://www.statmethods.net/input/dates.html
Documentation: https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/strptime 


---

class: tiny

### R scripts

```{embed, file = here("static", "extras", "gun-deaths.R"), echo = TRUE}
```

---

### When to use a script

* For troubleshooting
* Initial stages of project
* Building a reproducible pipeline
* It depends

--

### Running scripts

* Interactively
* Programmatically using `source()`

---

## Acknowledgments 

The content of these slides is derived in part from Benjamin Soltoff’s “Computing for the Social Sciences” course materials, licensed under the CC BY NC 4.0 Creative Commons License. Any errors or oversights are mine alone.